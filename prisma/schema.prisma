generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id                   String            @id @default(cuid())
  name                 String?
  email                String?           @unique
  emailVerified        DateTime?
  password             String?
  image                String?
  isPremium            Boolean           @default(false)
  isAdmin              Boolean           @default(false)
  stripeCustomerId     String?           @unique
  stripeSubscriptionId String?           @unique
  subscriptionStatus   String?
  subscriptionEndDate  DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  locale               String            @default("pt-BR")
  accounts             Account[]
  athleteFeedback      AthleteFeedback[]
  athleteProfile       AthleteProfile?
  sessions             Session[]
  subscription         Subscription?

  @@index([locale])
  @@map("users")
}

model Subscription {
  id                     String             @id @default(cuid())
  userId                 String             @unique
  stripeCustomerId       String?            @unique
  stripeSubscriptionId   String?            @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  status                 SubscriptionStatus @default(FREE)
  plan                   SubscriptionPlan   @default(FREE)
  trialEndsAt            DateTime?
  cancelAtPeriodEnd      Boolean            @default(false)
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Phase {
  id          Int             @id @default(autoincrement())
  phaseNumber Int             @unique
  name        String
  description String
  duration    String
  objectives  String
  focus       String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  nutrition   PhaseNutrition?
  weeks       Week[]

  @@map("phases")
}

model Week {
  id          Int       @id @default(autoincrement())
  weekNumber  Int       @unique
  phaseId     Int
  title       String
  volume      Float
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  phase       Phase     @relation(fields: [phaseId], references: [id])
  workouts    Workout[]

  @@map("weeks")
}

model Workout {
  id                Int                @id @default(autoincrement())
  weekId            Int
  dayOfWeek         Int
  dayName           String
  type              String
  subtype           String?
  distance          Float?
  duration          Int?
  pace              String?
  description       String
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  completedWorkouts CompletedWorkout[]
  week              Week               @relation(fields: [weekId], references: [id])

  @@map("workouts")
}

model VdotTable {
  id                  Int      @id @default(autoincrement())
  vdot                Float    @unique
  easy_pace_min       String
  easy_pace_max       String
  marathon_pace_min   String
  marathon_pace_max   String
  threshold_pace_min  String
  threshold_pace_max  String
  interval_pace_min   String
  interval_pace_max   String
  repetition_pace_min String
  repetition_pace_max String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("vdot_table")
}

model PhaseNutrition {
  id            Int      @id @default(autoincrement())
  phaseId       Int      @unique
  carbohydrates String
  protein       String
  fats          String
  calories      String
  hydration     String
  supplements   String?
  timing        String?
  special_notes String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  phase         Phase    @relation(fields: [phaseId], references: [id])

  @@map("phase_nutrition")
}

model InjuryPrevention {
  id           Int      @id @default(autoincrement())
  category     String
  name         String
  description  String
  duration     String?
  frequency    String
  instructions String
  benefits     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("injury_prevention")
}

model Glossary {
  id         Int      @id @default(autoincrement())
  term       String   @unique
  definition String
  category   String
  examples   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("glossary")
}

model OvertrainingSign {
  id          Int      @id @default(autoincrement())
  category    String
  sign        String
  description String
  severity    String
  action      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("overtraining_signs")
}

model AthleteProfile {
  id                    Int                 @id @default(autoincrement())
  userId                String              @unique
  weight                Float
  height                Float
  age                   Int?
  gender                String?
  runningLevel          String
  currentWeeklyKm       Float?
  longestRun            Float?
  experienceDescription String?
  experienceAnalysis    String?
  goalDistance          String?
  targetRaceDate        DateTime?
  targetTime            String?
  currentVDOT           Float?
  stravaConnected       Boolean             @default(false)
  stravaAthleteId       String?             @unique
  stravaAccessToken     String?
  stravaRefreshToken    String?
  stravaTokenExpiry     DateTime?
  injuries              Json?
  medicalConditions     String?
  medications           String?
  physicalRestrictions  String?
  weeklyAvailability    Int?                @default(5)
  trainingActivities    Json?
  autoAdjustEnabled     Boolean             @default(false)
  lastAutoAdjustDate    DateTime?
  longRunDay            Int?
  usualPaces            Json?
  injuryHistory         String?
  hasCustomPlan         Boolean             @default(false)
  customPlanId          Int?                @unique
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  preferredStartDate    DateTime?
  maxHeartRate          Int?
  recentLongRunPace     String?
  runningYears          Int?
  restingHeartRate      Int?
  sleepQuality          Int?
  stressLevel           Int?
  otherSportsExperience String?
  otherSportsYears      Int?
  injuryDetails         Json?
  injuryRecoveryStatus  String?
  lastInjuryDate        DateTime?
  bestTimes             Json?
  lastVDOTUpdate        DateTime?
  hasGymAccess          Boolean?            @default(false)
  hasPoolAccess         Boolean?            @default(false)
  hasTrackAccess        Boolean?            @default(false)
  trainingPreferences   Json?
  motivationFactors     Json?
  trainingSchedule      Json?               // v1.4.0 - Nova estrutura { 0: { running: true, activities: ['gym'] } }
  customActivities      Json?               // v1.4.0 - Esportes customizados ['pilates', 'crossfit']
  hasRunBefore          Boolean             @default(true)  // v3.0.0 - Distingue iniciante absoluto
  currentlyInjured      Boolean             @default(false) // v3.0.0 - Flag rápido lesão ativa
  avgSleepHours         Float?              // v3.0.0 - Horas médias sono/noite
  tracksMenstrualCycle  Boolean?            @default(false) // v3.0.0 - Tracking ciclo (women, opcional)
  avgCycleLength        Int?                // v3.0.0 - Duração média ciclo (dias)
  lastPeriodDate        DateTime?           // v3.0.0 - Data última menstruação
  workDemand            String?             // v3.0.0 - sedentary/moderate/physical
  familyDemand          String?             // v3.0.0 - low/moderate/high
  aiAnalyses            AIAnalysis[]
  customPlan            CustomTrainingPlan? @relation(fields: [customPlanId], references: [id])
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  completedWorkouts     CompletedWorkout[]
  raceGoals             RaceGoal[]
  trainingLogs          TrainingLog[]

  @@map("athlete_profiles")
}

model RaceGoal {
  id               Int            @id @default(autoincrement())
  athleteId        Int
  raceName         String
  distance         String
  raceDate         DateTime
  targetTime       String?
  location         String?
  priority         String         @default("C")
  autoClassified   Boolean        @default(true)
  status           String         @default("active")
  isPrimary        Boolean        @default(false)
  weeksBeforeA     Int?
  trainingSuggest  String?
  periodPhase      String?
  actualTime       String?
  placement        Int?
  notes            String?
  postRaceAnalysis String?
  lessonsLearned   Json?
  impactOnPlan     String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  athlete          AthleteProfile @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId, status])
  @@index([athleteId, priority])
  @@index([athleteId, raceDate])
  @@map("race_goals")
}

model CustomTrainingPlan {
  id                Int             @id @default(autoincrement())
  goalDistance      String?
  runningLevel      String
  targetRaceDate    DateTime?
  startDate         DateTime
  totalWeeks        Int
  currentWeek       Int             @default(1)
  primaryRaceGoalId Int?
  includesRaces     Json?
  lastRegenerated   DateTime?
  autoAdjustEnabled Boolean         @default(true)
  baseVDOT          Float?
  targetPace        String?
  isActive          Boolean         @default(true)
  completionRate    Float           @default(0)
  needsRegeneration Boolean         @default(false)
  periodization     Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  athleteProfile    AthleteProfile?
  weeks             CustomWeek[]
  planRevisions     PlanRevision[]

  @@map("custom_training_plans")
}

model PlanRevision {
  id          Int                @id @default(autoincrement())
  planId      Int
  reason      String
  description String
  changes     Json
  appliedAt   DateTime           @default(now())
  appliedBy   String?
  plan        CustomTrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId, appliedAt])
  @@map("plan_revisions")
}

model CustomWeek {
  id                Int                @id @default(autoincrement())
  planId            Int
  weekNumber        Int
  startDate         DateTime
  endDate           DateTime
  totalDistance     Float
  totalWorkouts     Int
  completedWorkouts Int                @default(0)
  phase             String
  focus             String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  plan              CustomTrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  workouts          CustomWorkout[]

  @@unique([planId, weekNumber])
  @@map("custom_weeks")
}

model CustomWorkout {
  id                 Int               @id @default(autoincrement())
  weekId             Int
  dayOfWeek          Int
  date               DateTime
  type               String
  subtype            String?
  title              String
  description        String
  distance           Float?
  duration           Int?
  targetPace         String?
  warmup             String?
  mainSet            String?
  cooldown           String?
  isCompleted        Boolean           @default(false)
  completedWorkoutId Int?              @unique
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  equipmentRequired  String?
  isStrengthSpecific Boolean           @default(false)
  targetHeartRate    String?
  targetRPE          Int?
  
  // v2.0.0 - Estrutura Detalhada de Treinos
  warmUpStructure    Json?             // Aquecimento detalhado (fase 1)
  mainWorkoutStruct  Json?             // Parte principal estruturada (fase 2)
  coolDownStructure  Json?             // Desaquecimento detalhado (fase 3)
  
  // v2.0.0 - Enriquecimento Educacional
  objective          String?           // Objetivo fisiológico do treino
  scientificBasis    String?           // Fundamento científico
  tips               Json?             // Array de dicas práticas
  commonMistakes     Json?             // Erros comuns a evitar
  successCriteria    Json?             // Critérios de sucesso
  
  // v2.0.0 - Métricas Avançadas
  intensityLevel     Int?              // 1-5 (Muito Leve → Muito Intenso)
  expectedRPE        Int?              // Rate of Perceived Exertion (1-10)
  heartRateZones     Json?             // Zonas de FC para cada fase
  intervals          Json?             // Estrutura de intervalos se aplicável
  expectedDuration   Int?              // Duração total esperada (minutos)
  
  athleteFeedback    AthleteFeedback[]
  completedWorkout   CompletedWorkout? @relation(fields: [completedWorkoutId], references: [id])
  week               CustomWeek        @relation(fields: [weekId], references: [id], onDelete: Cascade)

  @@map("custom_workouts")
}

model CompletedWorkout {
  id               Int            @id @default(autoincrement())
  athleteId        Int
  plannedWorkoutId Int?
  source           String
  stravaActivityId String?        @unique
  date             DateTime
  type             String
  subtype          String?
  distance         Float?
  duration         Int?
  pace             String?
  elevation        Float?
  avgHeartRate     Int?
  maxHeartRate     Int?
  calories         Int?
  perceivedEffort  Int?
  feeling          String?
  notes            String?
  hasInjuryAlert   Boolean        @default(false)
  injuryNotes      String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  athlete          AthleteProfile @relation(fields: [athleteId], references: [id])
  plannedWorkout   Workout?       @relation(fields: [plannedWorkoutId], references: [id])
  customWorkout    CustomWorkout?

  @@index([athleteId, date])
  @@index([stravaActivityId])
  @@map("completed_workouts")
}

model AIAnalysis {
  id              Int            @id @default(autoincrement())
  athleteId       Int
  analysisType    String
  startDate       DateTime
  endDate         DateTime
  summary         String
  insights        String
  recommendations String
  metrics         Json
  hasAlerts       Boolean        @default(false)
  alerts          String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  athlete         AthleteProfile @relation(fields: [athleteId], references: [id])

  @@index([athleteId, createdAt])
  @@map("ai_analyses")
}

model StravaWebhook {
  id             Int      @id @default(autoincrement())
  subscriptionId Int      @unique
  callbackUrl    String
  verifyToken    String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("strava_webhooks")
}

model TrainingLog {
  id                    Int            @id @default(autoincrement())
  athleteId             Int
  date                  DateTime
  plannedWorkoutId      Int?
  workoutCompleted      Boolean        @default(false)
  overallFeeling        String?
  energyLevel           Int?
  sleepQuality          Int?
  stressLevel           Int?
  motivationLevel       Int?
  trainingDifficulty    String?
  difficultyRating      Int?
  perceivedEffort       Int?
  hasPain               Boolean        @default(false)
  painDescription       String?
  painLocations         Json?
  painIntensity         Int?
  hasInjury             Boolean        @default(false)
  injuryDescription     String?
  hasIllness            Boolean        @default(false)
  illnessDescription    String?
  notes                 String?
  analyzed              Boolean        @default(false)
  aiAnalysis            String?
  aiAlerts              Json?
  requiresAttention     Boolean        @default(false)
  planAdjusted          Boolean        @default(false)
  adjustmentDescription String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  athlete               AthleteProfile @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([athleteId, date])
  @@map("training_logs")
}

model AthleteFeedback {
  id                  Int            @id @default(autoincrement())
  userId              String
  date                DateTime
  type                String
  message             String
  associatedWorkoutId Int?
  RPE                 Int?
  associatedWorkout   CustomWorkout? @relation(fields: [associatedWorkoutId], references: [id])
  user                User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@map("athlete_feedback")
}

enum SubscriptionStatus {
  FREE
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

enum SubscriptionPlan {
  FREE
  PREMIUM_MONTHLY
  PREMIUM_ANNUAL
}

model UserConsent {
  id            Int       @id @default(autoincrement())
  userId        String
  consentType   String
  consentedAt   DateTime  @default(now())
  ipAddress     String?
  userAgent     String?
  version       String    @default("1.0")
  revokedAt     DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, consentType, version])
  @@map("user_consents")
}
